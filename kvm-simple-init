#!/bin/sh

# kvm-simple-init
# Description : Simple init script to manage KVM virtual machines
# URL : https://github.com/tmartinfr/kvm-simple-init
# Author : Thomas Martin <thomas@oopss.org>

set -e

usage() {
	cat <<EOT
$0 [start|stop|restart] VM"

VM should match a configuration file in /etc/kvm-simple-init/.
EOT
	exit 1
}

if [ $# -ne 2 ]; then
	usage
fi

vmname="$2"
vmfile="/etc/kvm-simple-init/$vmname"

if ! [ -r "$vmfile" ]; then
	echo "$vmfile not readable. Aborting."
	exit 2
fi

source $vmfile

is_port_open() {
	nc -z localhost $1
}

if [ "$1" = "start" ]; then
	echo "Starting $vmname..."
	kvm $KVM_OPTS
	echo "Testing VM..."
	if is_port_open $MONITOR_PORT; then
		echo "VM started."
		exit 0
	else
		echo "Failed to start $vmname."
		exit 3
	fi
elif [ "$1" = "stop" ]; then
	echo "Stopping $vmname. Please wait."
	echo "system_powerdown" | nc localhost $MONITOR_PORT >/dev/null
fi

